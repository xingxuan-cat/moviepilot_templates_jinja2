{% set onl=original_name|lower %}{% set rgl=releaseGroup|lower %}{% set ns=namespace(WebRip='',audio=[],matched=false,dr='SDR',extra_list=[],channel='') %}{% set bit_depth_list=['8bit','10bit','12bit'] %}{% set bit_depth=(bit_depth_list|select('in',onl)|list|last) or '' %}{% set edition_mod_bd=['vcb-studio','moozzi2','mai','ye','mawen1250','acgnation'] %}{% set edition_mod_web=['lolihouse','sakurato','dynamis one'] %}{% set edition_mod='BluRay-Remux' if 'bdremux'in onl else 'BluRay-Rip' if edition_mod_bd|select('in',onl)|list|length>0 else 'Web-Rip' if edition_mod_web|select('in',onl)|list|length>0 and not resourceType else resourceType %}{% set WebRip_dict={'CR':['cr','crunchyroll'],'Baha':['baha','bahamut'],'BiliBili-Global':['b-global'],'BiliBili':['bilibili'],'ABEMA':['abema'],'Netflix':['netflix','nfx','nf'],'AmazonPrime':['prime','amazonprime','amzn'],'Hulu':['hulu'],'DisneyPlus':['disneyplus','disney+','disney_plus'],'HBO':['hbo','hbo max','hbomax'],'YouTubePremium':['youtube','ytpremium','ytp'],'AppleTV':['appletv','apple tv','apple_tv','atvp'],'Crunchyroll':['crunchyroll','crunchy'],'Funimation':['funimation','funi'],'Vimeo':['vimeo'],'Peacock':['peacock'],'ParamountPlus':['paramount+','paramountplus','paramount_plus'],'DAZN':['dazn'],'Tubi':['tubi'],'RakutenTV':['rakuten','rakutentv'],'Tencent Video':['tencent','tencentvideo'],'iQIYI':['iqiyi','爱奇艺','iqy'],'Youku':['youku','优酷'],'MangoTV':['mangotv','芒果tv','mgtv']} %}{% for platform,aliases in WebRip_dict.items() %}{% if ns.WebRip=='' %}{% for alias in aliases %}{% if alias|lower in onl %}{% set ns.WebRip=platform %}{% endif %}{% endfor %}{% endif %}{% endfor %}{% set audio_dict={'PCM':['pcm'],'TrueHD':['truehd'],'DTS-HD MA':['dts-hd ma','dts-hd.ma','dts-hd_ma','dts-hd.master'],'DTS-HD':['dts-hd','dts hd'],'DTS':['dts','dts5.1'],'FLAC':['flac'],'OPUS':['opus'],'DDP':['ddp','eac3','dd+'],'DD':['dd','ac3','ac-3'],'AAC':['aac']} %}{% set standard_audio_list=['PCM','TrueHD','DTS-HD MA','DTS-HD','DTS','FLAC','OPUS','DDP','DD','AAC'] %}{% for x in standard_audio_list %}{% set ns.matched=false %}{% for alias in audio_dict[x] %}{% if not ns.matched and alias in onl %}{% set ns.audio=ns.audio+[x] %}{% set ns.matched=true %}{% endif %}{% endfor %}{% endfor %}{% if 'DTS-HD MA' in ns.audio %}{% set ns.audio=ns.audio|reject('equalto','DTS-HD')|reject('equalto','DTS')|list %}{% elif 'DTS-HD' in ns.audio %}{% set ns.audio=ns.audio|reject('equalto','DTS')|list %}{% endif %}{% if 'DDP' in ns.audio %}{% set ns.audio=ns.audio|reject('equalto','DD')|list %}{% endif %}{% if '5.1.2audio' in onl %}{% set ns.channel='5.1ch' %}{% endif %}{% for x in ['7.1.4','7.1.2','7.1','5.1.4','5.1.2','5.1','2.0'] %}{% if ns.channel=='' and ('.'~x in onl or x in onl) %}{% set ns.channel=x~'ch' %}{% endif %}{% endfor %}{% set atmos='Atmos' if 'atmos' in onl else '' %}{% set audio_mod=ns.audio|join('&') %}{% if audio_mod and ns.channel %}{% set audio_mod=audio_mod~'_'~ns.channel %}{% endif %}{% if audio_mod and atmos %}{% set audio_mod=audio_mod~'.'~atmos %}{% endif %}{% if not audio_mod %}{% set audio_mod=audioCodec %}{% endif %}{% set dv_dict={'DolbyVision_Profile8.1':['p8.1'],'DolbyVision_Profile8':['p8'],'DolbyVision_Profile7':['p7'],'DolbyVision_Profile5':['p5'],'DolbyVision':['dv','dovi','dolbyvision','dolby.vision','dolby_vision']} %}{% set hdr_dict={'HDR_HDR10+':['hdr10+','hdr10plus','hdr10_plus'],'HDR_HDR10':['hdr10'],'HDR_HLG':['hlg'],'HDR':['hdr']} %}{% set tokens=onl.replace('.',' ').replace('_',' ').replace('-',' ').split() %}{% for profile,aliases in dv_dict.items() %}{% for alias in aliases %}{% if ns.dr=='SDR' and alias in tokens %}{% set ns.dr=profile %}{% endif %}{% endfor %}{% endfor %}{% if ns.dr=='SDR' %}{% for profile,aliases in hdr_dict.items() %}{% for alias in aliases %}{% if ns.dr=='SDR' and alias in tokens %}{% set ns.dr=profile %}{% endif %}{% endfor %}{% endfor %}{% endif %}{% for t in ['3d','imax','60fps','120fps'] %}{% if t in onl %}{% set upper=t|upper %}{% if upper not in ns.extra_list %}{% set ns.extra_list=ns.extra_list+[upper] %}{% endif %}{% endif %}{% endfor %}{% set extra=ns.extra_list|join(' ') %}{% set out=videoFormat|upper %}{% if edition_mod is defined %}{% set out=out~' '~edition_mod %}{% if ns.WebRip is defined %}{% set out=out~'.'~ns.WebRip %}{% endif %}{% endif %}{% if videoCodec is defined %}{% set out=out~' '~videoCodec %}{% if bit_depth is defined %}{% set out=out~'_'~bit_depth %}{% endif %}{% endif %}{% if audio_mod is defined %}{% set out=out~' '~audio_mod %}{% endif %}{% if ns.dr is defined and ns.dr!='SDR' %}{% set out=out~' '~ns.dr %}{% endif %}{% if extra is defined %}{% set out=out~' '~extra %}{% endif %}{% set full_name=title~' _ '~original_title~' ('~year~')/'~title~' - '~out~((" - " ~ releaseGroup) if releaseGroup else '')~fileExt %}{% if full_name|length>180 %}{{ title }} ({{ year }})/{{ title }} - {{ out }}{% if releaseGroup %} - {{ releaseGroup }}{% endif %}{{ fileExt }}{% else %}{{ full_name }}{% endif %}