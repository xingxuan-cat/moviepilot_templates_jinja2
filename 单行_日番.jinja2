{% set rgl=releaseGroup|default('')|lower %}{% set onl=original_name|default('')|lower %}{% set websrc=webSource|default('')|lower %}{% set ns=namespace(audio=[],matched=false,webrip='') %}{% set edition_mod_bd=['vcb-studio','moozzi2','mai','ye','mawen1250','acgnation'] %}{% set edition_mod_web=['lolihouse'] %}{% set edition_mod='BluRay-Remux' if 'bdremux' in onl else 'BluRay-Rip' if edition_mod_bd|select('in',rgl)|list|length>0 else 'WebRip' if (edition_mod_web|select('in',rgl)|list|length>0 or 'webrip' in onl or websrc) and not edition else edition %}{% set platform_map={'Netflix':['netflix','nf'],'Amazon':['amazon','amzn'],'DisneyPlus':['disney+','d+'],'AppleTVPlus':['apple tv+','atvp'],'Hulu':['hulu'],'Max':['hbo max','max'],'ParamountPlus':['paramount+','p+'],'Peacock':['peacock'],'CR':['cr','crunchyroll'],'Baha':['baha','bahamut'],'BiliBili-Global':['b-global'],'BiliBili':['bilibili'],'ABEMA':['abema'],'iQIYI':['iqiyi','qy'],'TencentVideo':['tencent','wetv'],'Youku':['youku','yk']} %}{% for key,val in platform_map.items() %}{% for alias in val %}{% if ns.webrip=='' and alias in websrc %}{% set ns.webrip=key %}{% elif ns.webrip=='' and alias in onl %}{% set ns.webrip=key %}{% endif %}{% endfor %}{% endfor %}{% set bitdepth=['8bit','10bit','12bit']|select('in',onl)|list|last|default('') %}{% set audio_dict={'PCM':['pcm'],'TrueHD':['truehd'],'DTS-HD MA':['dts-hd ma','dts-hd.ma','dts-hd_ma','dts-hd.master'],'DTS-HD':['dts-hd','dts hd'],'DTS':['dts','dts5.1'],'FLAC':['flac'],'OPUS':['opus'],'DDP':['ddp','eac3','dd+'],'DD':['dd','ac3','ac-3'],'AAC':['aac']} %}{% set priority=['AAC','DD','DDP','FLAC','OPUS','DTS','DTS-HD','DTS-HD MA','TrueHD','PCM'] %}{% for x in priority %}{% for alias in audio_dict[x] %}{% if alias in onl and x not in ns.audio %}{% set ns.audio=ns.audio+[x] %}{% endif %}{% endfor %}{% endfor %}{% if 'DTS-HD MA' in ns.audio %}{% set ns.audio=ns.audio|reject('equalto','DTS-HD')|reject('equalto','DTS')|list %}{% elif 'DTS-HD' in ns.audio %}{% set ns.audio=ns.audio|reject('equalto','DTS')|list %}{% endif %}{% if 'DDP' in ns.audio %}{% set ns.audio=ns.audio|reject('equalto','DD')|list %}{% endif %}{% set audio_codec_tag=ns.audio|join('&') %}{% set channel='' %}{% for ch in ['7.1.4','7.1.2','7.1','5.1.4','5.1.2','5.1','2.0'] %}{% if channel=='' and (ch in onl or ns.audio|map('lower')|map('string')|map('replace', '.','')|select('in', onl)|list|length>0 and ch in onl) %}{% set channel=ch~'ch' %}{% endif %}{% endfor %}{% set atmos='Atmos' if 'atmos' in onl else '' %}{% set audio_mod=audio_codec_tag %}{% if channel %}{% set audio_mod=audio_mod~'_'~channel %}{% endif %}{% if atmos %}{% set audio_mod=audio_mod~'.'~atmos %}{% endif %}{% set dr='SDR' %}{% if ['dv','dovi','dolbyvision']|select('in',onl)|list|length>0 %}{% if 'p8.1' in onl %}{% set dr='DolbyVision_Profile8.1' %}{% elif 'p7' in onl %}{% set dr='DolbyVision_Profile7' %}{% elif 'p8' in onl %}{% set dr='DolbyVision_Profile8' %}{% else %}{% set dr='DolbyVision' %}{% endif %}{% elif 'hdr10+' in onl %}{% set dr='HDR_HDR10+' %}{% elif 'hdr10' in onl %}{% set dr='HDR_HDR10' %}{% elif 'hlg' in onl %}{% set dr='HDR_HLG' %}{% elif 'hdr' in onl %}{% set dr='HDR' %}{% endif %}{% set extra=['3d','imax','60fps','120fps']|select('in',onl)|map('upper')|join(' ') %}{% set out=videoFormat|upper %}{% if edition_mod %}{% set out=out~' '~edition_mod %}{% if edition_mod=='WebRip' and ns.webrip %}{% set out=out~'.'~ns.webrip %}{% endif %}{% endif %}{% if videoCodec %}{% set out=out~' '~videoCodec %}{% if bitdepth %}{% set out=out~'_'~bitdepth %}{% endif %}{% elif bitdepth %}{% set out=out~' '~bitdepth %}{% endif %}{% if audio_mod %}{% set out=out~' '~audio_mod %}{% endif %}{% if dr %}{% set out=out~' '~dr %}{% endif %}{% if extra %}{% set out=out~' '~extra %}{% endif %}{{ title }} _ {{ en_title }} ({{ year }})/Season {{ season }}/{{ title }} - {{ season_episode }} - {{ out }}{% if releaseGroup %} - {{ releaseGroup }}{% endif %}{{ fileExt }}